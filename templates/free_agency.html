{% extends "base.html" %}

{% block content %}
<div class="container">
    <h1>Free Agency Market</h1>
    
    <!-- Current Offers Section -->
    <div class="section">
        <h2>Current Offers</h2>
        {% if current_offers %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Player</th>
                        <th>Current Salary</th>
                        <th>Offered Salary</th>
                        <th>Contract Years</th>
                        <th>Time Remaining</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for offer in current_offers %}
                        <tr>
                            <td>{{ offer.player_name }}</td>
                            <td>{{ offer.salary | int | format_currency }}</td>
                            <td>{{ offer.offered_salary | int | format_currency }}</td>
                            <td>{{ offer.offered_contract_years }}</td>
                            <td class="timer" data-expires="{{ offer.expires_at }}">--:--</td>
                            <td>
                                {% if offer.user_id != current_user.id %}
                                    <form method="POST" action="{{ url_for('raise_free_agent_offer', offer_id=offer.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-danger btn-sm raise-offer-btn" data-expires="{{ offer.expires_at }}" data-offer-id="{{ offer.id }}">Raise Offer</button>
                                    </form>
                                {% else %}
                                    <form method="POST" action="{{ url_for('raise_free_agent_offer', offer_id=offer.id) }}" style="display: inline;">
                                        <button type="submit" class="btn btn-warning btn-sm raise-offer-btn user-offer-btn" data-expires="{{ offer.expires_at }}" data-offer-id="{{ offer.id }}">Your offer</button>
                                    </form>
                                {% endif %}
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No active offers at the moment.</p>
        {% endif %}
        
        <!-- Process Expired Offers Button -->
        <div style="margin-top: 15px;">
            <form method="POST" action="{{ url_for('process_expired_offers_manual') }}" style="display: inline;">
                <button type="submit" class="btn btn-info">🔄 Process Expired Offers</button>
            </form>
            <small class="text-muted" style="margin-left: 10px;">Click to manually check and process any expired offers</small>
        </div>
    </div>

    <!-- Filter Section -->
    <div class="section">
        <h2>Filter Free Agents</h2>
        <form method="GET" action="{{ url_for('free_agency') }}" class="filter-form">
            <div class="row">
                <div class="col-md-3">
                    <label for="player_name">Player Name:</label>
                    <input type="text" class="form-control" id="player_name" name="player_name" placeholder="Search by name..." value="{{ request.args.get('player_name', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="min_salary">Min Salary (€):</label>
                    <input type="number" class="form-control" id="min_salary" name="min_salary" value="{{ request.args.get('min_salary', '') }}">
                </div>
                <div class="col-md-2">
                    <label for="max_salary">Max Salary (€):</label>
                    <input type="number" class="form-control" id="max_salary" name="max_salary" value="{{ request.args.get('max_salary', '') }}">
                </div>
                <div class="col-md-3">
                    <label for="position">Position:</label>
                    <select class="form-control" id="position" name="position">
                        <option value="">All Positions</option>
                        <option value="Goal-Keeper" {% if request.args.get('position') == 'Goal-Keeper' %}selected{% endif %}>Goal-Keeper</option>
                        <option value="Sweeper" {% if request.args.get('position') == 'Sweeper' %}selected{% endif %}>Sweeper</option>
                        <option value="Centre-Back" {% if request.args.get('position') == 'Centre-Back' %}selected{% endif %}>Centre-Back</option>
                        <option value="Side-Back" {% if request.args.get('position') == 'Side-Back' %}selected{% endif %}>Side-Back</option>
                        <option value="Defensive Midfielder" {% if request.args.get('position') == 'Defensive Midfielder' %}selected{% endif %}>Defensive Midfielder</option>
                        <option value="Wing-Back" {% if request.args.get('position') == 'Wing-Back' %}selected{% endif %}>Wing-Back</option>
                        <option value="Center-Midfielder" {% if request.args.get('position') == 'Center-Midfielder' %}selected{% endif %}>Center-Midfielder</option>
                        <option value="Side-Midfielder" {% if request.args.get('position') == 'Side-Midfielder' %}selected{% endif %}>Side-Midfielder</option>
                        <option value="Attacking Midfielder" {% if request.args.get('position') == 'Attacking Midfielder' %}selected{% endif %}>Attacking Midfielder</option>
                        <option value="Winger" {% if request.args.get('position') == 'Winger' %}selected{% endif %}>Winger</option>
                        <option value="Shadow Striker" {% if request.args.get('position') == 'Shadow Striker' %}selected{% endif %}>Shadow Striker</option>
                        <option value="Striker" {% if request.args.get('position') == 'Striker' %}selected{% endif %}>Striker</option>
                    </select>
                </div>
                <div class="col-md-2">
                    <label>&nbsp;</label><br>
                    <button type="submit" class="btn btn-primary">Filter</button>
                    <a href="{{ url_for('free_agency') }}" class="btn btn-secondary">Clear</a>
                </div>
            </div>
        </form>
    </div>

    <!-- Free Agents Section -->
    <div class="section">
        <h2>Available Free Agents</h2>
        {% if free_agents %}
            <table class="table">
                <thead>
                    <tr>
                        <th>Name</th>
                        <th>Age</th>
                        <th>Position</th>
                        <th>Side</th>
                        <th>Salary Demand</th>
                        <th>Contract Years</th>
                        <th>Attack</th>
                        <th>Defense</th>
                        <th>Physical</th>
                        <th>Power</th>
                        <th>Technique</th>
                        <th>GK</th>
                        <th>Action</th>
                    </tr>
                </thead>
                <tbody>
                    {% for player in free_agents %}
                        <tr>
                            <td><a href="{{ url_for('pes6_player_details', player_id=player.id) }}" style="color: #f39c12; text-decoration: none;">{{ player.player_name }}</a></td>
                            <td>{{ player.age }}</td>
                            <td>{{ player.game_position }}</td>
                            <td>{{ player.strong_foot }}</td>
                            <td>{{ player.salary | int | format_currency }}</td>
                            <td>{{ player.contract_years_remaining }}</td>
                            <td>{{ player.attack_rating }}</td>
                            <td>{{ player.defense_rating }}</td>
                            <td>{{ player.physical_rating }}</td>
                            <td>{{ player.power_rating }}</td>
                            <td>{{ player.technique_rating }}</td>
                            <td>{{ player.goalkeeping_rating }}</td>
                            <td>
                                <button type="button" class="btn btn-primary btn-sm" onclick="showOfferModal({{ player.id }}, &quot;{{ player.player_name }}&quot;, {{ player.salary }}, {{ player.contract_years_remaining }})">
                                    Make Offer
                                </button>
                            </td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        {% else %}
            <p>No free agents available at the moment.</p>
        {% endif %}
    </div>
</div>

<!-- Offer Modal -->
<div class="modal fade" id="offerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Make Offer to <span id="modalPlayerName"></span></h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <form method="POST" action="{{ url_for('make_free_agent_offer') }}">
                <div class="modal-body">
                    <input type="hidden" name="player_id" id="modalPlayerId">
                    
                    <div class="form-group">
                        <label>Current Salary: <span id="modalCurrentSalary"></span></label>
                    </div>
                    
                    <div class="form-group">
                        <label for="offered_salary">Offered Salary (€):</label>
                        <input type="number" class="form-control" id="offered_salary" name="offered_salary" required readonly>
                        <small class="form-text text-muted">You must offer the player's demanded salary for the initial offer.</small>
                    </div>
                    
                    <div class="form-group">
                        <label for="offered_contract_years">Contract Years:</label>
                        <input type="number" class="form-control" id="offered_contract_years" name="offered_contract_years" min="1" max="5" required readonly>
                        <small class="form-text text-muted">You must offer the player's demanded contract years for the initial offer.</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Make Offer</button>
                </div>
            </form>
        </div>
    </div>
</div>

<!-- Place Player Modal -->
<div class="modal fade" id="placePlayerModal" tabindex="-1" role="dialog">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Place Player in Team</h5>
                <button type="button" class="close" data-dismiss="modal">
                    <span>&times;</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="player-info">
                    <p><strong>Player:</strong> <span id="placePlayerName"></span></p>
                    <p><strong>Salary:</strong> <span id="placePlayerSalary"></span></p>
                    <p><strong>Contract Years:</strong> <span id="placePlayerYears"></span></p>
                    <p><strong>Status:</strong> <span class="text-danger">EXPIRED OFFER</span></p>
                </div>
                
                <div class="form-group">
                    <label for="teamSelect">Select Team:</label>
                    <select class="form-control" id="teamSelect" required>
                        <option value="">Loading teams...</option>
                    </select>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-success" id="confirmPlacePlayer">Place Player</button>
            </div>
        </div>
    </div>
</div>

<style>
.section {
    margin-bottom: 30px;
    padding: 20px;
    background: linear-gradient(145deg, #2c3e50, #34495e);
    border-radius: 10px;
    color: white;
}

.section h2 {
    color: #f39c12;
    margin-bottom: 20px;
}

.table {
    background: rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    overflow: hidden;
}

.table th {
    background: linear-gradient(145deg, #e67e22, #d35400);
    color: white;
    border: none;
}

.table td {
    border-color: rgba(255, 255, 255, 0.2);
    color: white;
}

.timer {
    font-weight: bold;
    color: #e74c3c;
}

.btn {
    border-radius: 20px;
    font-weight: bold;
}

.btn-primary {
    background: linear-gradient(145deg, #3498db, #2980b9);
    border: none;
}

.btn-warning {
    background: linear-gradient(145deg, #f1c40f, #f39c12);
    border: none;
}

.btn-danger {
    background: linear-gradient(145deg, #e74c3c, #c0392b);
    border: none;
}

.modal-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    color: white;
}

.modal-header {
    background: linear-gradient(145deg, #e67e22, #d35400);
    border-bottom: 2px solid #d35400;
}

.modal-title {
    color: white;
}

.form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
}

.form-control:focus {
    background: rgba(255, 255, 255, 0.2);
    border-color: #f39c12;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
}

.form-control::placeholder {
    color: rgba(255, 255, 255, 0.6);
}

.filter-form {
    background: rgba(255, 255, 255, 0.1);
    padding: 20px;
    border-radius: 8px;
    margin-bottom: 20px;
}

.filter-form label {
    color: #f39c12;
    font-weight: bold;
}

.filter-form .form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
}

.filter-form .form-control:focus {
    background: rgba(255, 255, 255, 0.2);
    border-color: #f39c12;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
}

.filter-form .btn {
    margin-top: 5px;
}

/* Free agency modal styling for better readability */
#offerModal .form-control {
    color: #000000 !important;
    background: #ffffff !important;
}

#offerModal .form-control:focus {
    color: #000000 !important;
    background: #ffffff !important;
}

#offerModal label {
    color: #000000 !important;
}

#offerModal .form-text {
    color: #000000 !important;
}

#offerModal .modal-body {
    background: #ffffff !important;
    color: #000000 !important;
}

#offerModal .modal-title {
    color: #000000 !important;
}

#offerModal .modal-header {
    background: #ffffff !important;
    color: #000000 !important;
}

/* Place Player Modal styling */
#placePlayerModal .modal-content {
    background: linear-gradient(145deg, #2c3e50, #34495e);
    color: white;
}

#placePlayerModal .modal-header {
    background: linear-gradient(145deg, #e67e22, #d35400);
    border-bottom: 2px solid #d35400;
}

#placePlayerModal .modal-title {
    color: white;
}

#placePlayerModal .player-info {
    background: rgba(255, 255, 255, 0.1);
    padding: 15px;
    border-radius: 8px;
    margin-bottom: 20px;
}

#placePlayerModal .player-info p {
    margin-bottom: 10px;
    font-size: 16px;
}

#placePlayerModal .form-group label {
    color: #f39c12;
    font-weight: bold;
}

#placePlayerModal .form-control {
    background: rgba(255, 255, 255, 0.1);
    border: 1px solid rgba(255, 255, 255, 0.3);
    color: white;
}

#placePlayerModal .form-control:focus {
    background: rgba(255, 255, 255, 0.2);
    border-color: #f39c12;
    color: white;
    box-shadow: 0 0 0 0.2rem rgba(243, 156, 18, 0.25);
}

#placePlayerModal .form-control option {
    background: #2c3e50;
    color: white;
}
</style>

<script>
function showOfferModal(playerId, playerName, currentSalary, currentContractYears) {
    document.getElementById('modalPlayerId').value = playerId;
    document.getElementById('modalPlayerName').textContent = playerName;
    document.getElementById('modalCurrentSalary').textContent = '€' + currentSalary.toLocaleString();
    document.getElementById('offered_salary').value = currentSalary;
    document.getElementById('offered_contract_years').value = currentContractYears;
    
    // Set readonly fields to player's demands
    document.getElementById('offered_salary').readOnly = true;
    document.getElementById('offered_contract_years').readOnly = true;
    
    $('#offerModal').modal('show');
}

// Timer functionality
function updateTimers() {
    const timers = document.querySelectorAll('.timer');
    timers.forEach(timer => {
        const expiresAt = new Date(timer.dataset.expires);
        const now = new Date();
        const diff = expiresAt - now;
        
        if (diff <= 0) {
            timer.textContent = 'EXPIRED';
            timer.style.color = '#e74c3c';
            
                                // Handle expired offers
                    const row = timer.closest('tr');
                    const raiseBtn = row.querySelector('.raise-offer-btn');
                    if (raiseBtn) {
                        // Check if this is the current user's offer
                        const isUserOffer = raiseBtn.classList.contains('user-offer-btn');
                        if (isUserOffer) {
                            // For user's own expired offers, change to "Place Player" button
                            raiseBtn.textContent = 'Place Player';
                            raiseBtn.classList.remove('btn-warning');
                            raiseBtn.classList.add('btn-success');
                            raiseBtn.disabled = false;
                            
                            // Change behavior to show place player modal
                            const offerId = raiseBtn.dataset.offerId;
                            if (offerId) {
                                raiseBtn.onclick = function(e) {
                                    e.preventDefault();
                                    showPlacePlayerModal(offerId, timer.closest('tr'));
                                };
                            }
                        } else {
                            // For other users' expired offers, just disable
                            raiseBtn.disabled = true;
                            raiseBtn.textContent = 'Expired';
                            raiseBtn.classList.remove('btn-danger');
                            raiseBtn.classList.add('btn-secondary');
                        }
                    }
        } else {
            const hours = Math.floor(diff / 3600000);
            const minutes = Math.floor((diff % 3600000) / 60000);
            const seconds = Math.floor((diff % 60000) / 1000);
            
            if (hours > 0) {
                timer.textContent = `${hours}h ${minutes}m ${seconds.toString().padStart(2, '0')}s`;
            } else {
                timer.textContent = `${minutes}:${seconds.toString().padStart(2, '0')}`;
            }
            
            if (hours < 1 && minutes < 10) {
                timer.style.color = '#e74c3c';
            } else if (hours < 1) {
                timer.style.color = '#f39c12';
            }
        }
    });
}

// Update timers every second
setInterval(updateTimers, 1000);
updateTimers(); // Initial call

// Check for expired offers every 30 seconds
setInterval(() => {
    fetch('/free_agency/check_expired_offers')
        .then(response => response.json())
        .then(data => {
            if (data.processed > 0) {
                console.log(`Processed ${data.processed} expired offers`);
                location.reload(); // Reload page if offers were processed
            }
        })
        .catch(error => console.error('Error checking expired offers:', error));
}, 30000); // Check every 30 seconds

// Place Player Modal Functions
let currentOfferId = null;
let currentPlayerRow = null;

function showPlacePlayerModal(offerId, playerRow) {
    currentOfferId = offerId;
    currentPlayerRow = playerRow;
    
    // Get player details from the row
    const playerName = playerRow.querySelector('td:first-child').textContent;
    const salary = playerRow.querySelector('td:nth-child(4)').textContent;
    const years = playerRow.querySelector('td:nth-child(5)').textContent;
    
    // Populate modal with player info
    document.getElementById('placePlayerName').textContent = playerName;
    document.getElementById('placePlayerSalary').textContent = salary;
    document.getElementById('placePlayerYears').textContent = years;
    
    // Load user teams
    loadUserTeams();
    
    // Show modal
    $('#placePlayerModal').modal('show');
}

function loadUserTeams() {
    const teamSelect = document.getElementById('teamSelect');
    teamSelect.innerHTML = '<option value="">Loading teams...</option>';
    
    fetch('/free_agency/get_user_teams')
        .then(response => response.json())
        .then(data => {
            teamSelect.innerHTML = '<option value="">-- Select a Team --</option>';
            data.teams.forEach(team => {
                const option = document.createElement('option');
                option.value = team.id;
                option.textContent = team.name;
                teamSelect.appendChild(option);
            });
        })
        .catch(error => {
            console.error('Error loading teams:', error);
            teamSelect.innerHTML = '<option value="">Error loading teams</option>';
        });
}

// Handle place player confirmation
document.getElementById('confirmPlacePlayer').addEventListener('click', function() {
    const selectedTeamId = document.getElementById('teamSelect').value;
    
    if (!selectedTeamId) {
        alert('Please select a team');
        return;
    }
    
    // Disable button during request
    this.disabled = true;
    this.textContent = 'Placing...';
    
    fetch(`/free_agency/place_player/${currentOfferId}`, {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            selected_team_id: selectedTeamId
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            $('#placePlayerModal').modal('hide');
            // Remove the row from the current offers table
            if (currentPlayerRow) {
                currentPlayerRow.remove();
            }
            // Show success message
            alert(`✅ ${data.message}`);
        } else {
            alert(`❌ Error: ${data.error}`);
        }
    })
    .catch(error => {
        console.error('Error placing player:', error);
        alert('❌ An error occurred while placing the player.');
    })
    .finally(() => {
        // Re-enable button
        this.disabled = false;
        this.textContent = 'Place Player';
    });
});
</script>
{% endblock %} 